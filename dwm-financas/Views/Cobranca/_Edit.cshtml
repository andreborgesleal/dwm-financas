@using DWM.Models.Repositories
@model EditarContaReceberViewModel
@{
    Layout = null;
    var path = System.Configuration.ConfigurationManager.AppSettings["Users_Data"];
}
<div class="container">
    <div id="div-lov"></div>
    @Html.Partial("_alerts")
    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">Editar Contas a Receber</h3>
        </div>
        <div class="panel-body">
            <!-- Contas a receber -->
            <div class="row clearfix">
                <div class="col-md-4">
                    <ul class="list-group">
                        <li class="list-group-item">
                            <h4><strong>Operação</strong></h4>
                            @(Model.operacaoId + "-" + Model.parcelaId.ToString())
                        </li>
                        <li class="list-group-item">
                            <h4><strong>Emissão</strong></h4>
                            @Model.dt_emissao.ToString("dd/MM/yyyy")
                        </li>
                        <li class="list-group-item">
                            <h4><strong>Cliente</strong></h4>
                            @Model.nome_cliente <br />
                            <small>@Model.descricao_grupoCliente</small>
                        </li>
                        <li class="list-group-item">
                            <h4><strong>Histórico</strong></h4>
                            @(Model.descricao_historico + " " + Model.complementoHist)
                        </li>
                        @if (Model.centroCustoId.HasValue)
                        {
                            <li class="list-group-item">
                                <h4><strong>Centro de Custo</strong></h4>
                                @Model.descricao_centroCusto
                            </li>
                        }
                        <li class="list-group-item">
                            <h4><strong>Total</strong></h4>
                            @Model.vr_total.ToString("R$ ###,###,##0.00") -
                            <span class="text-prateado"> @Model.qte_parcelas parcela(s)</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-8">
                    <!------------------->
                    <!-- Contabilidade -->
                    <!------------------->
                    @if (Model.Contabilidades != null && Model.Contabilidades.Count() > 0)
                    {
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <h3 class="panel-title">Contabildiade <a href="../Contabilidade/Edit?contabilidadeId=@Model.Contabilidades.FirstOrDefault().contabilidadeId" class="pull-right">#@Model.Contabilidades.FirstOrDefault().contabilidadeId </a></h3>
                            </div>
                            <div class="panel-body">
                                @if (Model.Contabilidades.Count() > 0)
                                {
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <tr class="active">
                                                <td><strong>Conta</strong></td>
                                                <td><strong>Descrição</strong></td>
                                                <td class="text-right"><strong>Débito</strong></td>
                                                <td class="text-right"><strong>Crédito</strong></td>
                                            </tr>
                                            @foreach (ContabilidadeItemViewModel item in Model.Contabilidades)
                                            {
                                                <tr>
                                                    <td>@item.codigoReduzido</td>
                                                    <td>@item.descricao_planoConta</td>
                                                    <td class="text-right">@(item.tipoLancamento == "D" ? item.valor.ToString("###,###,###,##0.00") : "")</td>
                                                    <td class="text-right">@(item.tipoLancamento == "C" ? item.valor.ToString("###,###,###,##0.00") : "")</td>
                                                </tr>
                                            }
                                            <tr class="warning">
                                                <td colspan="2"><strong>Total</strong></td>
                                                <td class="text-right"><strong>@Model.Contabilidades.Where(tipo => tipo.tipoLancamento == "D").Select(info => info.valor).Sum().ToString("###,###,###,##0.00")</strong></td>
                                                <td class="text-right"><strong>@Model.Contabilidades.Where(tipo => tipo.tipoLancamento == "C").Select(info => info.valor).Sum().ToString("###,###,###,##0.00")</strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                }

                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="well text-center">Não há lançamento contábil para esta operação</div>
                    }
                    <!--------------------->
                    <!-- Dados do Título -->
                    <!--------------------->
                    <div class="panel panel-info">
                        <div class="panel-heading">
                            <h3 class="panel-title">Dados do Título</h3>
                        </div>
                        <div class="panel-body">
                            <div class="row clearfix">
                                <div class="col-md-6">
                                    <h4>
                                        <strong>Vencimento</strong>
                                    </h4>
                                    <h3>
                                        <strong class="text-danger">@Model.dt_vencimento.ToString("dd/MM/yyyy")</strong>
                                    </h3>
                                </div>
                                <div class="col-md-6">
                                    <h4><strong>Banco</strong></h4>
                                    <h4 class="text-muted">@(Model.bancoId.ToString() + "-" + Model.nome_banco)</h4>
                                </div>
                            </div>
                            <div class="row clearfix">
                                <div class="col-md-6">
                                    <h4><strong>Saldo Devedor</strong></h4>
                                    <h4 class="text-muted">@(Model.vr_saldo_devedor.HasValue ? Model.vr_saldo_devedor.Value.ToString("R$ ###,###,###,##0.00") : "0,00")</h4>
                                </div>
                                <div class="col-md-6">
                                    <h4><strong>Forma de Pagamento</strong></h4>
                                    <h4 class="text-muted">@Model.descricao_forma_pagamento</h4>
                                </div>
                            </div>
                            <div class="row clearfix">
                                <div class="col-md-6">
                                    <h4><strong>Situação</strong></h4>
                                    <h4 class="text-muted">@Model.situacao</h4>
                                </div>
                                <div class="col-md-6">
                                    <h4><strong>Data da Baixa</strong></h4>
                                    @if (Model.dt_baixa.HasValue)
                                    {
                                        <h4 class="text-muted">@Model.dt_baixa.Value.ToString("dd/MM/yyyy")</h4>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Posição financeira do título -->
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Posição financeira do título</h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped">
                        <tr class="active">
                            <td><strong>Atraso</strong></td>
                            <td class="text-center"><strong>Última amortização</strong></td>
                            <td><strong>Cheque</strong></td>
                            <td class="text-right"><strong>Valor principal</strong></td>
                            <td class="text-right"><strong>Amortização</strong></td>
                            <td class="text-right"><strong>Encargos</strong></td>
                            <td class="text-right"><strong>Desconto</strong></td>
                            <td class="text-right"><strong>Valor Pago</strong></td>
                            <td class="text-right"><strong>Saldo devedor</strong></td>
                        </tr>
                        <tr>
                            <td>@(Model.atraso.HasValue && Model.atraso.Value > 0 ? Model.atraso.ToString() + " dias" : "")</td>
                            <td class="text-center">@(Model.dt_ultima_amortizacao.HasValue ? Model.dt_ultima_amortizacao.Value.ToString("dd/MM/yyyy") : "")</td>
                            <td>@(Model.cheque_numero != null && Model.cheque_numero != "" ? "Banco: " + Model.cheque_banco + " Agência: " + Model.cheque_agencia + " Ch. " + Model.cheque_numero : "")</td>
                            <td class="text-right">@Model.vr_principal.ToString("###,###,###,##0.00")</td>
                            <td class="text-right">@(Model.vr_amortizacao.HasValue && Model.vr_amortizacao.Value > 0 ? Model.vr_amortizacao.Value.ToString("###,###,###,##0.00") : "")</td>
                            <td class="text-right">@(Model.vr_encargos.HasValue && Model.vr_encargos.Value > 0 ? Model.vr_encargos.Value.ToString("###,###,###,##0.00") : "")</td>
                            <td class="text-right">@(Model.vr_desconto.HasValue && Model.vr_desconto.Value > 0 ? Model.vr_desconto.Value.ToString("###,###,###,##0.00") : "")</td>
                            <td class="text-right">@(Model.vr_total_pago.HasValue && Model.vr_total_pago.Value > 0 ? Model.vr_total_pago.Value.ToString("###,###,###,##0.00") : "")</td>
                            <td class="text-right">@(Model.vr_saldo_devedor.HasValue && Model.vr_saldo_devedor.Value > 0 ? Model.vr_saldo_devedor.Value.ToString("R$ ###,###,###,##0.00") : "R$ 0,00")</td>
                        </tr>
                    </table>
                </div>
            </div>
            <!-- Eventos -->
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">Eventos</h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped">
                        <tr class="active">
                            <td class="text-center"><strong>Ação</strong></td>
                            <td><strong>Data</strong></td>
                            <td><strong>Evento</strong></td>
                            <td class="text-center"><strong>Ocorrência</strong></td>
                            <td class="text-center"><strong>Contabilidade</strong></td>
                            <td class="text-center"><strong>Movimento <br />Bancário</strong></td>
                            <td class="text-center"><strong>Tipo</strong></td>
                            <td class="text-right"><strong>Valor</strong></td>
                            <td class="text-center"><strong>Arquivo</strong></td>
                        </tr>
                        @foreach (ContaReceberParcelaEventoViewModel ev in Model.OperacaoParcelaEventos)
                        {
                            string estornar = "Estornar";
                            string classe = "";
                            string tachado = "";
                            if (ev.ind_estorno == "S")
                            {
                                classe = "danger";
                                tachado = "riscado";
                                estornar = "Estornado";
                            }

                            <tr class="@classe">
                                @if (!"0|8".Contains(ev.ind_tipoEvento.Trim()) && ev.ind_estorno == "N")
                                {
                                    <td class="text-center"><a class="primary dedo-indicador" onclick="fnEstorno('@ev.operacaoId', '@ev.parcelaId', '@ev.dt_evento.ToString("yyyy-MM-dd HH:mm:ss.fff tt")')">@estornar</a></td>
                                }
                                else
                                {
                                    <td class="text-center"><a class="primary">@estornar</a></td>
                                }
                                <td>@ev.dt_evento.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="@tachado">@ev.descricao_evento</td>
                                <td class="text-center">@ev.dt_ocorrencia.ToString("dd/MM/yyyy")</td>
                                @if (ev.contabilidadeId.HasValue)
                                {
                                    <td class="text-center">
                                        <a href="#" data-toggle="modal" data-target="#myModal3" onclick="showContabilidade('@ev.contabilidadeId')">#@ev.contabilidadeId</a>
                                    </td>
                                }
                                else
                                {
                                    <td>&nbsp;</td>
                                }
                                @if (ev.movtoBancarioId.HasValue)
                                {
                                    <td class="text-center">
                                        <a href="#" data-toggle="modal" data-target="#myModal2" onclick="showMovtoBancario('@ev.movtoBancarioId')">#@ev.movtoBancarioId</a>
                                    </td>
                                }
                                else
                                {
                                    <td>&nbsp;</td>
                                }
                                <td class="text-center">@ev.ind_operacao</td>
                                <td class="text-right @tachado">@ev.valor.ToString("###,###,###,##0.00")</td>
                                @if (ev.arquivo != null && ev.arquivo != "")
                                {
                                    <td class="text-center"><a class="label label-primary" data-toggle="modal" data-target="#myModal1" onclick="visualizar('@ev.arquivo', '@ev.arquivo_extensao')" href="#" title="Visualizar arquivo">Visualizar</a></td>
                                }
                                else
                                {
                                    <td>&nbsp;</td>
                                }
                            </tr>
                        }
                    </table>
                </div>
            </div>
            <!-- Tab (Baixa/Eventos/Alterar)-->
            <div>
                <div class="well-sm">
                    @Html.Partial("_alerts")
                </div>
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#baixar" aria-controls="baixar" role="tab" data-toggle="tab"><i class="fa fa-check-square fa-2x"> Baixar</i></a></li>
                    <li role="presentation"><a href="#evento" aria-controls="evento" role="tab" data-toggle="tab"><i class="fa fa-newspaper-o fa-2x"> Novo Evento</i></a></li>
                    <li role="presentation"><a href="#alterar" aria-controls="alterar" role="tab" data-toggle="tab"><i class="fa fa-edit fa-2x"> Alterar</i></a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                    <!-- Baixar por motivo de liquidação -->
                    <div role="tabpanel" class="tab-pane active" id="baixar">
                        @if (Model.ind_baixa == null || Model.ind_baixa == "")
                        {
                            <div id="baixa_motivo_liquidacao">
                                @Html.Partial("_Baixar", Model)
                            </div>
                        }
                        else
                        {
                            <div class="well text-center margem-topo-10">Título Baixado</div>
                        }
                    </div>
                    <!-- Novo Evento -->
                    <div role="tabpanel" class="tab-pane" id="evento">
                        @if (Model.ind_baixa == null || Model.ind_baixa == "")
                        {
                            <div id="novo-evento">
                                @Html.Partial("_Evento", Model.editarOperacaoParcelaEventoViewModel)
                            </div>
                        }
                        else
                        {
                            <div class="well text-center margem-topo-10">Título Baixado</div>
                        }
                    </div>
                    <!-- Alterar Título -->
                    <div role="tabpanel" class="tab-pane" id="alterar">
                        @if (Model.ind_baixa == null || Model.ind_baixa == "")
                        {
                            if (Model.OperacaoParcelaEventos.Where(info => info.ind_estorno == "N").Count() > 1)
                            {
                                <div class="well text-center margem-topo-10">Título não pode ser editado porque possui movimentação</div>
                            }
                            else
                            {
                                <div id="novo-evento">
                                    @Html.Partial("_Modify", Model)
                                </div>
                            }
                        }
                        else
                        {
                            <div class="well text-center margem-topo-10">Título Baixado</div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function fnEstorno(_operacaoId, _parcelaId, _dt_evento)
    {
        var link = '../Cobranca/Estornar?operacaoId=' + _operacaoId + '&parcelaId=' + _parcelaId + '&dt_evento=' + _dt_evento;
        link = encodeURI(link + '&noCahce=' + new Date());
        CarregandoIn();

        $('#EditarContaReceber').load(link);
        
        $( document ).ajaxSuccess(function (event, xhr, settings) {
            $('#carregando').css("visibility", "hidden");
            $('#carregando').css("height", "0px");
            $('#carregando').css("margin-top", "0%");
            $('#carregando').css("margin-left", "0%");
        }).error(function () {
            $('#carregando').css("visibility", "hidden");
            $('#carregando').css("height", "0px");
            $('#carregando').css("margin-top", "0%");
            $('#carregando').css("margin-left", "0%");
        })
    }
</script>